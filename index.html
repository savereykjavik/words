<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <link href='http://fonts.googleapis.com/css?family=Merriweather:300italic,300' rel='stylesheet' type='text/css'>
    <link rel='stylesheet' href='spectrum.css'/>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>

    <script src="colorbrewer.js" type="text/javascript"></script>
    <script src="d3.min.js" charset="utf-8"></script>
    <script src='spectrum.js'></script>
    <script src="thousand.js" type="text/javascript"></script>
    <script src="hundred.js" type="text/javascript"></script>

<style type="text/css">

body {
  font-family: 'Merriweather', serif;
}

h2 {
  font-style: italic;
  font-weight: 300;
}
p {
  font-weight: 300;
}

.tiny {
  font-size: 12px;
  line-height: 26px;
  margin-left: 40px;
}
#wrapper {
  width: 800px;
  height: 700px;
  margin-left: auto;
  margin-right: auto;
  padding-top: 40px;
  padding-bottom: 40px;
}

.wrapper {
  width: 800px;
  margin-left: auto;
  margin-right: auto;
  padding-top: 10px;
}

#wrapper1 {
  float: left;
  width: 390px;
}
#wrapper2 {
  width: 390px;
  float: right;
}

#title1 {
  max-width: 360px;
  margin-right: 10px
}

#title2 {
  max-width: 360px;
  margin-right: 10px
}

#test {
  font-family: 'Merriweather', serif;
  font-stretch: extra-expanded;
  font-size: 11pt;
  position: fixed;
  left: -99999px;
}

#book1 {
  overflow-y: scroll;
  height: 525px !important;
  margin-right: 10px
}

#book2 {
  overflow-y: scroll;
  height: 525px !important;
}

.book:hover {
    cursor: pointer;
}

.rect:hover {
    opacity: 0.1 !important;
}

.rect {
}

.text {
  font-family: 'Merriweather', serif;
  font-stretch: extra-expanded;
  pointer-events: none;
}

.text:hover {
    
}

.text {
  transition: opacity .10s ease-in-out;
  -moz-transition: opacity .10s ease-in-out;
  -webkit-transition: opacity .10s ease-in-out;
}

.word {
  transition: opacity .20s ease-in-out;
  -moz-transition: opacity .20s ease-in-out;
  -webkit-transition: opacity .20s ease-in-out;
}

.full-spectrum .sp-palette {
max-width: 200px;
}

.input {
  width: 40px;
  height: 20px;
  font-family: "Helvetica Neue", Helvetica, sans-serif;
  font-size: 10pt;
  border-width: 1px #91765d;
  padding-left: 10px;
  font-weight: 300;
}



</style>
</head>

<body>

<!-- wrapper for the top section that contains the toggle/controls to change color etc -->
<div class=wrapper>
  <p class="tiny">
    <!-- <input type='text' id="full" style=""/>  Color of the common words.       -->
    <input type='text' id="boxinput" class="input" placeholder='20'/>  &nbsp; &nbsp; Height of the 'rows'. Press enter to change. (The length of boxes doesn't change because it's determined by textsize) </br>
    <input type='text' id="textsizeinput" class="input" placeholder='10'/>  &nbsp; &nbsp; Textsize. usually about half of Height is good. (This one takes a really long time to draw. because it has to recalculate the whole layot and positioning of every word. It's like when first loading the page).
  </p>

  <p class="tiny">
    <input type='text' id="full2" style=""/>  Color of the complex words.
    <input type='checkbox' id="checkbox" style=""/> See the text.
    
    <!-- <input type='text' id="widthinput" class="input" placeholder='word'/>  &nbsp; &nbsp; Length of the boxes compared to height. 1 = square. (Press enter to change) -->
  </p>

  <p class="tiny">
    <form id="radios">
  <input type="radio" name="thousands" value="one" checked>1000
  <input type="radio" name="thousands" value="two">2000
  <input type="radio" name="thousands" value="three">3000
  <input type="radio" name="thousands" value="four">4000
  <input type="radio" name="thousands" value="five">5000
</form>
  </p>
</div>

<span id="test">
</span>

<!-- wrapper for our main section -->
<div id="wrapper">
  <h1>The colors of books</h1>
  <h2>- Judging a book by its colors</h2>
</br>
  <div id="wrapper1">
    <div id="title1"><p>The little prince </br>Antoine de Saint-Exupéry 1943</p></div>
    <div id="book1" class="book"></div>
    <div id="result1"></div>
  </div>

  <div id="wrapper2">
    <div id="title2"><p>Hamlet</br> William Shakespeare 1600</p></div>
    <div id="book2" class="book"></div>
    <div id="result2"></div>
  </div>
</div>
</br>

<script type="text/javascript">

/// TOGGLES 

$("#full").spectrum({
    color: "#FFFFFF",
    showInput: true,
    className: "full-spectrum",
    showInitial: true,
    showPalette: true,
    showSelectionPalette: true,
    maxPaletteSize: 10,
    preferredFormat: "hex",
    localStorageKey: "spectrum.demo",
    move: function (color) {
        
    },
    show: function () {
    
    },
    beforeShow: function () {
    
    },
    hide: function () {
    
    },
    change: function(color) {
      commoncolor = color.toHexString(); // #ff0000
      console.log(commoncolor);
      drawBook(group1A, group1B, data1);
      drawBook(group2A, group2B, data2);
        
    },
    palette: [
        ["rgb(0, 0, 0)", "rgb(67, 67, 67)", "rgb(102, 102, 102)",
        "rgb(204, 204, 204)", "rgb(217, 217, 217)","rgb(255, 255, 255)"],
        ["rgb(152, 0, 0)", "rgb(255, 0, 0)", "rgb(255, 153, 0)", "rgb(255, 255, 0)", "rgb(0, 255, 0)",
        "rgb(0, 255, 255)", "rgb(74, 134, 232)", "rgb(0, 0, 255)", "rgb(153, 0, 255)", "rgb(255, 0, 255)"], 
        ["rgb(230, 184, 175)", "rgb(244, 204, 204)", "rgb(252, 229, 205)", "rgb(255, 242, 204)", "rgb(217, 234, 211)", 
        "rgb(208, 224, 227)", "rgb(201, 218, 248)", "rgb(207, 226, 243)", "rgb(217, 210, 233)", "rgb(234, 209, 220)", 
        "rgb(221, 126, 107)", "rgb(234, 153, 153)", "rgb(249, 203, 156)", "rgb(255, 229, 153)", "rgb(182, 215, 168)", 
        "rgb(162, 196, 201)", "rgb(164, 194, 244)", "rgb(159, 197, 232)", "rgb(180, 167, 214)", "rgb(213, 166, 189)", 
        "rgb(204, 65, 37)", "rgb(224, 102, 102)", "rgb(246, 178, 107)", "rgb(255, 217, 102)", "rgb(147, 196, 125)", 
        "rgb(118, 165, 175)", "rgb(109, 158, 235)", "rgb(111, 168, 220)", "rgb(142, 124, 195)", "rgb(194, 123, 160)",
        "rgb(166, 28, 0)", "rgb(204, 0, 0)", "rgb(230, 145, 56)", "rgb(241, 194, 50)", "rgb(106, 168, 79)",
        "rgb(69, 129, 142)", "rgb(60, 120, 216)", "rgb(61, 133, 198)", "rgb(103, 78, 167)", "rgb(166, 77, 121)",
        "rgb(91, 15, 0)", "rgb(102, 0, 0)", "rgb(120, 63, 4)", "rgb(127, 96, 0)", "rgb(39, 78, 19)", 
        "rgb(12, 52, 61)", "rgb(28, 69, 135)", "rgb(7, 55, 99)", "rgb(32, 18, 77)", "rgb(76, 17, 48)"]
    ]
});

$("#full2").spectrum({
    color: "#D2E4C4",
    showInput: true,
    className: "full-spectrum",
    showInitial: true,
    showPalette: true,
    showSelectionPalette: true,
    maxPaletteSize: 10,
    preferredFormat: "hex",
    localStorageKey: "spectrum.demo",
    move: function (color) {
        
    },
    show: function () {
    
    },
    beforeShow: function () {
    
    },
    hide: function () {
    
    },
    change: function(color) {
      complexcolor = color.toHexString(); // #ff0000
      console.log(complexcolor);
      drawBook(group1A, group1B, data1);
      drawBook(group2A, group2B, data2);
    },
    palette: [
        ["rgb(0, 0, 0)", "rgb(67, 67, 67)", "rgb(102, 102, 102)",
        "rgb(204, 204, 204)", "rgb(217, 217, 217)","rgb(255, 255, 255)"],
        ["rgb(152, 0, 0)", "rgb(255, 0, 0)", "rgb(255, 153, 0)", "rgb(255, 255, 0)", "rgb(0, 255, 0)",
        "rgb(0, 255, 255)", "rgb(74, 134, 232)", "rgb(0, 0, 255)", "rgb(153, 0, 255)", "rgb(255, 0, 255)"], 
        ["rgb(230, 184, 175)", "rgb(244, 204, 204)", "rgb(252, 229, 205)", "rgb(255, 242, 204)", "rgb(217, 234, 211)", 
        "rgb(208, 224, 227)", "rgb(201, 218, 248)", "rgb(207, 226, 243)", "rgb(217, 210, 233)", "rgb(234, 209, 220)", 
        "rgb(221, 126, 107)", "rgb(234, 153, 153)", "rgb(249, 203, 156)", "rgb(255, 229, 153)", "rgb(182, 215, 168)", 
        "rgb(162, 196, 201)", "rgb(164, 194, 244)", "rgb(159, 197, 232)", "rgb(180, 167, 214)", "rgb(213, 166, 189)", 
        "rgb(204, 65, 37)", "rgb(224, 102, 102)", "rgb(246, 178, 107)", "rgb(255, 217, 102)", "rgb(147, 196, 125)", 
        "rgb(118, 165, 175)", "rgb(109, 158, 235)", "rgb(111, 168, 220)", "rgb(142, 124, 195)", "rgb(194, 123, 160)",
        "rgb(166, 28, 0)", "rgb(204, 0, 0)", "rgb(230, 145, 56)", "rgb(241, 194, 50)", "rgb(106, 168, 79)",
        "rgb(69, 129, 142)", "rgb(60, 120, 216)", "rgb(61, 133, 198)", "rgb(103, 78, 167)", "rgb(166, 77, 121)",
        "rgb(91, 15, 0)", "rgb(102, 0, 0)", "rgb(120, 63, 4)", "rgb(127, 96, 0)", "rgb(39, 78, 19)", 
        "rgb(12, 52, 61)", "rgb(28, 69, 135)", "rgb(7, 55, 99)", "rgb(32, 18, 77)", "rgb(76, 17, 48)"]
    ]
});


$('#boxinput').keypress(function(event) {
      if (event.keyCode == 13) {
          boxside = $("#boxinput").attr('value') *1;
          drawBook(group1A, group1B, data1);
          drawBook(group2A, group2B, data2);
      }
});

$('#widthinput').keypress(function(event) {
      if (event.keyCode == 13) {
          widthfactor = $("#widthinput").attr('value') *1;
          drawBook(group1A, group1B, data1);
          drawBook(group2A, group2B, data2);
      }
});

$('#textsizeinput').keypress(function(event) {
      if (event.keyCode == 13) {
          textsize = $("#textsizeinput").attr('value') *1;
          $("#test").css("font-size", textsize + "pt");
          start();
      }
});

var one = thousand1;
var two = thousand1.concat(thousand2);
var three = thousand1.concat(thousand2).concat(thousand3);
var four = thousand1.concat(thousand2).concat(thousand3).concat(thousand4);
var five = thousand1.concat(thousand2).concat(thousand3).concat(thousand4).concat(thousand5);


$("input[name=thousands]:radio").change(function () {
    if ( $('input[name=thousands]:checked', '#radios').val() == "one") {
      thousands = one;
    } else if ( $('input[name=thousands]:checked', '#radios').val() == "two") {
      thousands = two;
    } else if ( $('input[name=thousands]:checked', '#radios').val() == "three") {
      thousands = three;
    } else if ( $('input[name=thousands]:checked', '#radios').val() == "four") {
      thousands = four;
    } else if ( $('input[name=thousands]:checked', '#radios').val() == "five") {
      thousands = five;
  }
  start();
  });

// END OF TOGGLES



var margin = {top: 0, right: 20, bottom: 0, left: 20},
width = 390 - margin.left - margin.right,
height = 5000 - margin.top - margin.bottom;

var thousands = thousand1;

// create an object of the common words: "Word" : index
var commonObj = {};
for (var i = 0; i < thousands.length; i++) {
  commonObj[thousands[i]] = i;
}


// function to get width of a text in html
function getWidth(word) {
    return $("#test").text(word).width();
}

// function to layout one line of text
function layoutLine(line, y, layout, xwidth) {
    var x = 0;
    var fill = width - xwidth;
    var justify = fill < width * 0.2;
    var add = justify ? fill / (line.length) : 0;

    line.forEach(function(word) {
        var cleanword = word.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,"").toLowerCase();
        var wordWidth = getWidth(word) + 3 + add;
        layout.push({
            "type": 'word',
            "word": word,
            "cleanword": cleanword,
            "common" : isCommon(cleanword),
            "commoni" : commonIndex(cleanword),
            "x": x,
            "y": y,
            "add": add,
            "width": wordWidth
        });
        x += wordWidth;
    });
}

function layoutLines(lines) {
    var y = 0;
    var layout = [];
    lines.forEach(function(line) {
        var x = 0;
        var workingLine = [];
        line.forEach(function(word) {
            if (word == "") return;
            var wordWidth = getWidth(word) + 3;
            if (x + wordWidth <= width) {
                // line is not done
                workingLine.push(word);
                x += wordWidth;
            } else {
                // line is already done
                // do something about it
                layoutLine(workingLine, y, layout, x);
                // prepare for next line
                workingLine = [word];
                x = wordWidth;
                y++;
            }
        });
        // layout any remainder of the line
        if (workingLine.length > 0) {
            layoutLine(workingLine, y, layout, x);
        }
        y++;
    });
    return layout;
}

// gets the textfile
function getText(txtfile, callback) {
  $.get( txtfile, function (text) {
        var lines = window.lines = text.split('\n')
            .map(function(line) {
                return line.trim().split(/\s+/);
            });
        callback(lines);
    });
}

function start() {

      getText( "books/tinyprince.txt", function (lines) {
        var layout = layoutLines(lines);
        data1 = layout;
        drawBook(group1A, group1B, data1);
        // countWords(data1, "#result1");
        console.log(layout);
    });
    getText( "books/tinyhamlet.txt", function (lines) {
        var layout = layoutLines(lines);
        data2 = layout;
        drawBook(group2A, group2B, data2);
        // countWords(data1, "#result1");
        console.log(layout);
    });

};

// runs when all is loaded
jQuery(function() {

  start();

});

// Checks if a word is common. Returns True/False
function isCommon(word) {
  return commonObj[word] != undefined;
}
function commonIndex(word) {
  return commonObj[word] != undefined ? commonObj[word] : -1;
}
// Counts words and sends the result to target div
function countWords(words, target) {

  //words.filter genererar en lista av alla words där isCommon = true
  var commonNo = words.filter(isCommon).length;
  var complexNo = words.length - commonNo;

  var percent = commonNo/(commonNo+complexNo)*100;

  $(target).html("<p>" + Math.round(percent) +"% written with hundred most common words </p> <p>" + (commonNo+complexNo) + " words in total </p>" );

}

var firstblue = ["#003478", "#335D93", "#6685AE", "#99AEC9", "#CCD6E4"];
var cyanblue = ["#237475", "#3E968F", "#5CADAA", "#85D4C4", "#ABE8D9"];
var emelieblue = ["#117475", "#47ADA5", "#74D2C5", "#A2E8D7", "#DCFFEE"];
var bluetextrange = ["#335D93", "#6685AE", "#99AEC9", "#CCD6E4", "#CCD6E4" ];

// Creates a linear color scale
var bwcolor = d3.scale.linear()
  .domain([ 0, thousands.length-1])
  .range(colorbrewer.Greys[2]);

// Creates a linear opacity scale
var opacityscale = d3.scale.linear()
  .domain([ 0, 10])
  .range([1, 0.5]);

// Creates a linear bluescale
var commonBluescale = d3.scale.quantize()
  .domain([0, 0.1*thousands.length, 0.2*thousands.length, 0.5*thousands.length, thousands.length])
  .range(emelieblue);

// Creates a linear bluescale
var blueText = d3.scale.linear()
  .domain([0, 0.25*thousands.length, 0.5*thousands.length, 0.75*thousands.length, thousands.length])
  .range(bluetextrange);

// D3 SVG and group layout

function drawSVG(foo) {
  return foo.append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.bottom + margin.top)
    .style("margin-left", -margin.left)
    .style("margin.right", -margin.right)
    .style("fill", complexcolor)
    ;
}

function makeG(foo) {
  return foo.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
}

var svg1 = drawSVG(d3.select("#book1"));
var svg2 = drawSVG(d3.select("#book2"));

var group1A = makeG(svg1);
var group1B = makeG(svg1);
var group2A = makeG(svg2);
var group2B = makeG(svg2);

// Parameters

var boxside = 18;
var widthfactor = 20;
var commoncolor = "#d7b8e3";
var complexcolor = "#e0f9ee";
var bgcolor = "#FFFFFF";
var seetext = true;
var data1;
var data2;
var textsize = 10;

// set the css initially, to the textsize

$( "#checkbox" ).change(function() {
  seetext = !seetext;
  drawBook(group1A, group1B, data1);
  drawBook(group2A, group2B, data2);
});


// Draws text

function drawText(text) {
  text.classed("text", true)
    .classed("word", true)
    .text(function(d) {
      return d.word;
    })
    .attr("x", function(d, i) {
      return d.x;
    })
    .attr("y", function(d,i) {
      return d.y * boxside;
    })
    .attr("dx", function(d) { return 2 + "px"; })
    .attr("dy", textsize + 0.2 + "pt")
    .attr("width", function(d) { return d.width; })
    .attr("height", boxside)
    .style("opacity", function(d) {
      return seetext == true ? 1 : 0;
    })
    .style("font-size", textsize + "pt")
    .style("letter-spacing", function(d) {
      return d.add / (d.word.length -1) + "px";
    })
    // .style("font-weight", 100)
    .style("fill", function(d) {
        return d.common ? commonBluescale(d.commoni) : complexcolor;
    });
}

// D3 happens
// Draws rectangles

function drawRect(rect) {
  rect.classed("word", true)
    .classed("rect", true)
    .attr("x", function(d, i) {
      return d.x;
    })
    .attr("y", function(d,i) {
      return d.y * boxside;
    })
    .attr("width", function(d) { return d.width; })
    .attr("height", boxside)
    .style("fill", function(d) {
        return d.common ? commonBluescale(d.commoni) : complexcolor;
    })
    .style("opacity", function(d) {
      return 1;
      //return d.common ? 0.9 : opacityscale(d.word.length) *0.7;
    })
    .style("stroke", "#FFFFFF")
    .style("stroke-width", function(d) {
        return d.common ? "0.5pt" : "0.5pt";
    })
    ;
}



// Draw book

function drawBook(rect, text, words) {

  var bookrect = rect.selectAll("rect")
    .data(words);
  var booktext = text.selectAll("text")
    .data(words);

  //new
  bookrect.enter().append("rect");
  booktext.enter().append("text");

  // new and existing
  drawRect(bookrect);
  drawText(booktext);

}

// function draw() {
//   drawBook(group1A, group1B, data1);
//   drawBook(group2A, group2B, data2);

// };



</script>
</body>
</html>